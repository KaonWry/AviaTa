<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>AviaTa – E-Ticket Saya</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="Assets/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Library untuk PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body class="tickets-page">

  <!-- NAVBAR -->
  <header class="site-header">
    <nav class="navbar">
      <div class="nav-left">
        <div class="brand-logo"></div>
        <div class="brand-name">AviaTa</div>
      </div>

      <div class="nav-right">
        <button class="lang-select">
          <span class="flag-dot"></span>
          <span>ID/EN</span>
        </button>

        <div class="user-menu">
          <button type="button" class="user-menu-toggle" data-user-menu-toggle>
            <div class="user-avatar">U</div>
            <span class="user-name">Username</span>
            <span>▾</span>
          </button>

          <div class="user-dropdown">
            <a href="index-user.html">Beranda</a>
            <a href="tickets.html">E-Ticket Saya</a>
            <a href="tracking.html">Tracking Penerbangan</a>
            <a href="profile.html">Profil</a>
            <a href="index-guest.html">Logout</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- CONTENT  -->
  <h1>E-Ticket Saya</h1>

  <!--  TIKET AKTIF  -->
  <h2>Tiket Aktif</h2>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Nama Penumpang</th>
        <th>Nomor Tiket</th>
        <th>Rute</th>
        <th>Tanggal Penerbangan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="active-tickets"></tbody>
  </table>

  <!-- TIKET EXPIRED -->
  <h2 style="margin-top:60px;">Tiket Kadaluarsa</h2>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Nama Penumpang</th>
        <th>Nomor Tiket</th>
        <th>Rute</th>
        <th>Tanggal Penerbangan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="expired-tickets"></tbody>
  </table>


  <!-- FOOTER -->
  <footer class="site-footer" style="margin-top:80px;">
    <div class="footer-inner">
      <div class="footer-col">
        <h4>AviaTa</h4>
        <ul class="footer-list">
          <li><a href="#">Help Centre</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Partnership</a></li>
          <li><a href="#">Advertising</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Tentang AviaTa</h4>
        <ul class="footer-list">
          <li><a href="#">Tentang kami</a></li>
          <li><a href="#">Kebijakan privasi</a></li>
          <li><a href="#">Syarat & ketentuan</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Kontak kami</h4>
        <div class="footer-social">
          <span class="footer-social-icon">IG</span>
          <span class="footer-social-icon"><i class="fa-brands fa-facebook"></i></span>
          <span class="footer-social-icon"><i class="fa-brands fa-x-twitter"></i></span>
        </div>
      </div>
    </div>
    <div class="footer-bottom">© 2025 AviaTa. All rights reserved.</div>
  </footer>


  <!-- USER MENU DROPDOWN -->
  <script>
    const userMenuToggle = document.querySelector("[data-user-menu-toggle]");
    const userMenu = document.querySelector(".user-menu");

    if (userMenuToggle) {
      userMenuToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        userMenu.classList.toggle("is-open");
      });

      document.addEventListener("click", () => {
        userMenu.classList.remove("is-open");
      });
    }
  </script>


  <!-- ETICKET SCRIPT -->
  <script>
    const activeTable = document.getElementById("active-tickets");
    const expiredTable = document.getElementById("expired-tickets");

    let tickets = JSON.parse(localStorage.getItem("tickets")) || [];

    function isExpired(date) {
      return new Date(date) < new Date();
    }

    function formatDate(str) {
      let d = new Date(str);
      return d.toLocaleDateString("id-ID", { year: "numeric", month: "long", day: "numeric" });
    }

    function renderTickets() {
      activeTable.innerHTML = "";
      expiredTable.innerHTML = "";

      if (tickets.length === 0) {
        activeTable.innerHTML = `<tr><td colspan="6" style="text-align:center;">Belum ada tiket.</td></tr>`;
        expiredTable.innerHTML = `<tr><td colspan="6" style="text-align:center;">Tidak ada tiket kadaluarsa.</td></tr>`;
        return;
      }

      tickets.forEach((t, index) => {
        let row = `
          <tr>
            <td>${index + 1}</td>
            <td>${t.name}</td>
            <td>${t.ticketNumber}</td>
            <td>${t.route}</td>
            <td>${formatDate(t.travelDate)}</td>
            <td>
              <button class="btn-download" onclick="downloadTicket(${t.id})">Download</button>
              <button class="btn-delete" onclick="deleteTicket(${t.id})">Hapus</button>
            </td>
          </tr>
        `;

        if (isExpired(t.travelDate)) expiredTable.innerHTML += row;
        else activeTable.innerHTML += row;
      });
    }

    function deleteTicket(id) {
      tickets = tickets.filter(t => t.id !== id);
      localStorage.setItem("tickets", JSON.stringify(tickets));
      renderTickets();
    }

    async function downloadTicket(id) {
      const { jsPDF } = window.jspdf;

      let t = tickets.find(t => t.id === id);
      if (!t) return alert("Tiket tidak ditemukan");

      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("E-TICKET | AviaTa", 20, 20);

      doc.setFontSize(12);
      doc.text(`Nomor Tiket: ${t.ticketNumber}`, 20, 40);
      doc.text(`Nama Penumpang: ${t.name}`, 20, 50);
      doc.text(`Maskapai: ${t.airline}`, 20, 60);
      doc.text(`Kode Penerbangan: ${t.flightCode}`, 20, 70);

      doc.text(`Rute: ${t.route}`, 20, 90);
      doc.text(`Berangkat: ${t.depart}`, 20, 100);
      doc.text(`Tiba: ${t.arrive}`, 20, 110);
      doc.text(`Tanggal Penerbangan: ${formatDate(t.travelDate)}`, 20, 120);

      doc.text(`Fasilitas: ${t.facilities}`, 20, 140);

      doc.setFontSize(14);
      doc.text(`Total Dibayar: IDR ${t.price.toLocaleString("id-ID")}`, 20, 160);

      doc.save(`E-Ticket-${t.ticketNumber}.pdf`);
    }

    renderTickets();
  </script>

</body>
</html>
